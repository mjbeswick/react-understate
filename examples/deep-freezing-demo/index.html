<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>React Understate - Deep Freezing Demo</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .demo-section {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .success {
            color: #28a745;
            font-weight: bold;
        }
        .error {
            color: #dc3545;
            font-weight: bold;
        }
        .info {
            color: #17a2b8;
            font-weight: bold;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        pre {
            background: #f1f3f4;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .console {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>üßä React Understate - Deep Freezing Demo</h1>
    
    <p>This demo showcases the automatic deep freezing functionality that prevents accidental mutations of state objects and arrays.</p>

    <div class="demo-section">
        <h2>Object Deep Freezing</h2>
        <p>Objects are automatically frozen when set in state:</p>
        <button onclick="testObjectFreezing()">Test Object Freezing</button>
        <div id="object-results"></div>
    </div>

    <div class="demo-section">
        <h2>Array Deep Freezing</h2>
        <p>Arrays are automatically frozen when set in state:</p>
        <button onclick="testArrayFreezing()">Test Array Freezing</button>
        <div id="array-results"></div>
    </div>

    <div class="demo-section">
        <h2>Nested Object Freezing</h2>
        <p>Deep freezing works recursively on nested objects:</p>
        <button onclick="testNestedFreezing()">Test Nested Freezing</button>
        <div id="nested-results"></div>
    </div>

    <div class="demo-section">
        <h2>Console Output</h2>
        <div id="console" class="console"></div>
    </div>

    <script type="module">
        import { state } from '../../dist/react-understate.esm.js';

        // Global state for demo
        window.demoState = {
            user: state({ name: 'John', age: 30, preferences: { theme: 'dark' } }),
            items: state(['apple', 'banana']),
            nested: state({
                level1: {
                    level2: {
                        level3: { value: 'deep' }
                    }
                }
            })
        };

        // Console logging function
        window.log = function(message, type = 'info') {
            const console = document.getElementById('console');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : '#17a2b8';
            console.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            console.scrollTop = console.scrollHeight;
        };

        // Test object freezing
        window.testObjectFreezing = function() {
            const results = document.getElementById('object-results');
            results.innerHTML = '';

            try {
                const user = window.demoState.user;
                
                // Test if object is frozen
                const isFrozen = Object.isFrozen(user.value);
                log(`Object frozen: ${isFrozen}`, isFrozen ? 'success' : 'error');
                
                // Try to mutate (this should fail)
                try {
                    user.value.name = 'Jane';
                    log('‚ùå Mutation succeeded (unexpected)', 'error');
                } catch (e) {
                    log('‚úÖ Mutation failed as expected: ' + e.message, 'success');
                }

                // Update using immutable pattern
                user.value = { ...user.value, name: 'Jane' };
                log('‚úÖ Immutable update succeeded', 'success');
                log(`New name: ${user.value.name}`, 'info');

                // Verify new object is also frozen
                const newIsFrozen = Object.isFrozen(user.value);
                log(`New object frozen: ${newIsFrozen}`, newIsFrozen ? 'success' : 'error');

                results.innerHTML = `
                    <div class="success">‚úÖ Object freezing test completed successfully!</div>
                    <pre>Object is frozen: ${isFrozen}
New object is frozen: ${newIsFrozen}
Current value: ${JSON.stringify(user.value, null, 2)}</pre>
                `;
            } catch (e) {
                log('‚ùå Test failed: ' + e.message, 'error');
                results.innerHTML = `<div class="error">‚ùå Test failed: ${e.message}</div>`;
            }
        };

        // Test array freezing
        window.testArrayFreezing = function() {
            const results = document.getElementById('array-results');
            results.innerHTML = '';

            try {
                const items = window.demoState.items;
                
                // Test if array is frozen
                const isFrozen = Object.isFrozen(items.value);
                log(`Array frozen: ${isFrozen}`, isFrozen ? 'success' : 'error');
                
                // Try to mutate (this should fail)
                try {
                    items.value.push('cherry');
                    log('‚ùå Array mutation succeeded (unexpected)', 'error');
                } catch (e) {
                    log('‚úÖ Array mutation failed as expected: ' + e.message, 'success');
                }

                // Update using immutable pattern
                items.value = [...items.value, 'cherry'];
                log('‚úÖ Immutable array update succeeded', 'success');
                log(`New items: ${items.value.join(', ')}`, 'info');

                // Verify new array is also frozen
                const newIsFrozen = Object.isFrozen(items.value);
                log(`New array frozen: ${newIsFrozen}`, newIsFrozen ? 'success' : 'error');

                results.innerHTML = `
                    <div class="success">‚úÖ Array freezing test completed successfully!</div>
                    <pre>Array is frozen: ${isFrozen}
New array is frozen: ${newIsFrozen}
Current value: [${items.value.join(', ')}]</pre>
                `;
            } catch (e) {
                log('‚ùå Test failed: ' + e.message, 'error');
                results.innerHTML = `<div class="error">‚ùå Test failed: ${e.message}</div>`;
            }
        };

        // Test nested freezing
        window.testNestedFreezing = function() {
            const results = document.getElementById('nested-results');
            results.innerHTML = '';

            try {
                const nested = window.demoState.nested;
                
                // Test if all levels are frozen
                const level1Frozen = Object.isFrozen(nested.value.level1);
                const level2Frozen = Object.isFrozen(nested.value.level1.level2);
                const level3Frozen = Object.isFrozen(nested.value.level1.level2.level3);
                
                log(`Level 1 frozen: ${level1Frozen}`, level1Frozen ? 'success' : 'error');
                log(`Level 2 frozen: ${level2Frozen}`, level2Frozen ? 'success' : 'error');
                log(`Level 3 frozen: ${level3Frozen}`, level3Frozen ? 'success' : 'error');
                
                // Try to mutate at different levels
                try {
                    nested.value.level1.level2.level3.value = 'shallow';
                    log('‚ùå Deep mutation succeeded (unexpected)', 'error');
                } catch (e) {
                    log('‚úÖ Deep mutation failed as expected: ' + e.message, 'success');
                }

                // Update using immutable pattern
                nested.value = {
                    ...nested.value,
                    level1: {
                        ...nested.value.level1,
                        level2: {
                            ...nested.value.level1.level2,
                            level3: { value: 'updated' }
                        }
                    }
                };
                log('‚úÖ Deep immutable update succeeded', 'success');
                log(`New deep value: ${nested.value.level1.level2.level3.value}`, 'info');

                results.innerHTML = `
                    <div class="success">‚úÖ Nested freezing test completed successfully!</div>
                    <pre>Level 1 frozen: ${level1Frozen}
Level 2 frozen: ${level2Frozen}
Level 3 frozen: ${level3Frozen}
Current value: ${JSON.stringify(nested.value, null, 2)}</pre>
                `;
            } catch (e) {
                log('‚ùå Test failed: ' + e.message, 'error');
                results.innerHTML = `<div class="error">‚ùå Test failed: ${e.message}</div>`;
            }
        };

        // Initialize demo
        log('üöÄ Deep Freezing Demo loaded successfully!', 'success');
        log('Click the test buttons above to see deep freezing in action.', 'info');
    </script>
</body>
</html>
